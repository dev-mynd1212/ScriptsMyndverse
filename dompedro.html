<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Assinatura Digital • MyndVerse</title>

<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#0b0f17;
  color:#fff;
}

.container{
  max-width:900px;
  margin:auto;
  padding:20px;
}

h2{ margin-top:0 }

canvas{
  width:100%;
  height:160px;
  background:#fff;
  border-radius:10px;
}

button{
  padding:12px 16px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  margin-top:10px;
  cursor:pointer;
}

.primary{ background:#6ea8ff; }
.success{ background:#2ee59d; }
.danger{ background:#ff5d5d; }

.pageWrap{
  position:relative;
  margin-bottom:20px;
}

#pages canvas{
  width:100%;
  height:auto;
  display:block;
}
</style>
</head>

<body>
<div class="container">

<h2>Assine abaixo</h2>

<canvas id="sigCanvas"></canvas>

<br>
<button class="danger" id="clearSig">Limpar</button>
<button class="primary" id="addSig">Adicionar na 2ª página</button>
<button class="success" id="exportPdf" disabled>Baixar PDF assinado</button>

<p id="status"></p>

<hr style="opacity:.2;margin:30px 0">

<div id="pages"></div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

<script>
const PDF_PATH = "./Mynd.pdf";
const SIGN_PAGE_INDEX = 1; // segunda página

pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const sigCanvas = document.getElementById("sigCanvas");
const sctx = sigCanvas.getContext("2d");
const pagesEl = document.getElementById("pages");
const exportBtn = document.getElementById("exportPdf");
const addSigBtn = document.getElementById("addSig");
const clearSigBtn = document.getElementById("clearSig");
const statusEl = document.getElementById("status");

let drawing=false;
let hasInk=false;
let pdfDoc=null;
let stampData=null;

function setStatus(msg){ statusEl.innerText=msg; }

// ===== ASSINATURA =====
function resizeSig(){
  const rect=sigCanvas.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  sigCanvas.width=rect.width*dpr;
  sigCanvas.height=rect.height*dpr;
  sctx.setTransform(dpr,0,0,dpr,0,0);
  sctx.lineWidth=2.5;
  sctx.lineCap="round";
  sctx.strokeStyle="#000";
}
resizeSig();
window.addEventListener("resize",resizeSig);

function getPos(e){
  const rect=sigCanvas.getBoundingClientRect();
  const x=(e.clientX||e.touches?.[0].clientX)-rect.left;
  const y=(e.clientY||e.touches?.[0].clientY)-rect.top;
  return{x,y};
}

sigCanvas.addEventListener("pointerdown",e=>{
  drawing=true;
  const p=getPos(e);
  sctx.beginPath();
  sctx.moveTo(p.x,p.y);
});
sigCanvas.addEventListener("pointermove",e=>{
  if(!drawing)return;
  const p=getPos(e);
  sctx.lineTo(p.x,p.y);
  sctx.stroke();
  hasInk=true;
});
window.addEventListener("pointerup",()=>drawing=false);

clearSigBtn.onclick=()=>{
  sctx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  hasInk=false;
  stampData=null;
  setStatus("Assinatura limpa.");
};

// ===== RENDER PDF =====
async function loadPdf(){
  pdfDoc=await pdfjsLib.getDocument(PDF_PATH).promise;
  pagesEl.innerHTML="";

  for(let i=1;i<=pdfDoc.numPages;i++){
    const page=await pdfDoc.getPage(i);
    const base=page.getViewport({scale:1});
    const containerWidth=pagesEl.clientWidth;
    const scale=containerWidth/base.width;
    const viewport=page.getViewport({scale});

    const wrap=document.createElement("div");
    wrap.className="pageWrap";

    const canvas=document.createElement("canvas");
    const ctx=canvas.getContext("2d");

    canvas.width=viewport.width;
    canvas.height=viewport.height;

    await page.render({canvasContext:ctx,viewport}).promise;

    wrap.appendChild(canvas);

    if(i-1===SIGN_PAGE_INDEX){
      const overlay=document.createElement("div");
      overlay.id="signOverlay";
      overlay.style.position="absolute";
      overlay.style.inset="0";
      overlay.style.pointerEvents="none";
      wrap.appendChild(overlay);
    }

    pagesEl.appendChild(wrap);
  }

  setStatus("PDF carregado.");
}
loadPdf();

window.addEventListener("resize",loadPdf);

// ===== ADICIONAR ASSINATURA =====
addSigBtn.onclick=()=>{
  if(!hasInk){
    setStatus("Assine antes.");
    return;
  }

  const overlay=document.getElementById("signOverlay");
  overlay.innerHTML="";

  stampData=sigCanvas.toDataURL("image/png");

  const img=document.createElement("img");
  img.src=stampData;
  img.style.position="absolute";
  img.style.left="40px";
  img.style.top="120px";
  img.style.width="200px";
  img.style.cursor="move";

  overlay.style.pointerEvents="auto";
  overlay.appendChild(img);

  enableDrag(img);
  exportBtn.disabled=false;
};

function enableDrag(el){
  let dragging=false,startX=0,startY=0,origX=0,origY=0;

  el.addEventListener("pointerdown",e=>{
    dragging=true;
    startX=e.clientX;
    startY=e.clientY;
    origX=parseFloat(el.style.left);
    origY=parseFloat(el.style.top);
  });

  window.addEventListener("pointermove",e=>{
    if(!dragging)return;
    el.style.left=(origX+(e.clientX-startX))+"px";
    el.style.top=(origY+(e.clientY-startY))+"px";
  });

  window.addEventListener("pointerup",()=>dragging=false);
}

// ===== EXPORTAR =====
exportBtn.onclick=async()=>{
  if(!stampData){
    setStatus("Adicione a assinatura.");
    return;
  }

  setStatus("Gerando PDF...");

  const pdfBytes=await fetch(PDF_PATH).then(r=>r.arrayBuffer());
  const doc=await PDFLib.PDFDocument.load(pdfBytes);

  const page=doc.getPage(SIGN_PAGE_INDEX);
  const {width,height}=page.getSize();

  const overlay=document.getElementById("signOverlay");
  const img=overlay.querySelector("img");

  const overlayW=overlay.clientWidth;
  const overlayH=overlay.clientHeight;

  const leftPx=parseFloat(img.style.left);
  const topPx=parseFloat(img.style.top);
  const stampWpx=img.getBoundingClientRect().width;
  const stampHpx=img.getBoundingClientRect().height;

  const x=(leftPx/overlayW)*width;
  const w=(stampWpx/overlayW)*width;
  const h=(stampHpx/overlayH)*height;
  const y=height-((topPx/overlayH)*height)-h;

  const pngBytes=await fetch(stampData).then(r=>r.arrayBuffer());
  const pngImage=await doc.embedPng(pngBytes);

  page.drawImage(pngImage,{x,y,width:w,height:h});

  const out=await doc.save();
  const blob=new Blob([out],{type:"application/pdf"});
  const url=URL.createObjectURL(blob);

  const a=document.createElement("a");
  a.href=url;
  a.download="Mynd_assinado.pdf";
  a.click();

  setStatus("PDF baixado ✅");
};
</script>
</body>
</html>

<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Assinatura Digital • MyndVerse</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

  <style>
    :root{
      --bg:#0b0f17; --card:#0f1625; --card2:#0c1220; --line:#1f2a3d;
      --txt:#eaf0ff; --muted:#a9b6d3; --accent:#6ea8ff; --ok:#2ee59d;
      --shadow: 0 20px 60px rgba(0,0,0,.45); --radius: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, sans-serif;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{
      margin:0; font-family:var(--font); background: var(--bg); color:var(--txt);
      min-height:100vh; overflow-x: hidden;
    }

    header{
      padding:20px; max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
    }
    .logo{
      width:30px; height:30px; border-radius:8px;
      background: linear-gradient(135deg, #6ea8ff, #2ee59d);
    }

    /* Ajuste para Mobile */
    .wrap{
      max-width:1200px; margin:0 auto; padding:10px;
      display:grid; grid-template-columns: 1fr; gap:15px;
    }
    @media (min-width: 980px){ .wrap{ grid-template-columns: 350px 1fr; } }

    .card{
      background: var(--card); border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius); overflow:hidden; padding:15px;
    }

    /* Área do PDF - Crucial para não cortar no iPhone */
    .stage{
      position:relative; width:100%; overflow: hidden;
      background: #333; border-radius: 10px;
    }
    #pdfCanvas{ width: 100% !important; height: auto !important; display: block; }

    /* Assinatura */
    .sigcanvas{
      width:100%; height:180px; background: #fff; /* Fundo branco para enxergar a tinta preta */
      border-radius:12px; touch-action:none; border: 2px solid var(--line);
    }

    #sigStamp{
      position:absolute; left:20px; top:20px; width:150px;
      cursor:move; touch-action:none; display:none; z-index: 10;
      filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
    }

    button{
      width:100%; padding:14px; margin:5px 0; border-radius:12px; border:none;
      font-weight:bold; cursor:pointer; font-size: 14px;
    }
    .primary{ background: var(--accent); color:#000; }
    .success{ background: var(--ok); color:#000; }
    .danger{ background: rgba(255,255,255,0.1); color:#fff; }
    button:disabled{ opacity: 0.3; }

    .status{ font-size:12px; color:var(--muted); text-align:center; margin-top:10px; }
  </style>
</head>

<body>
<header>
  <div style="display:flex; gap:10px; align-items:center;">
    <div class="logo"></div>
    <b>MyndVerse</b>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h3 style="margin-top:0">1. Assine com o dedo</h3>
    <canvas id="sigCanvas" class="sigcanvas"></canvas>
    
    <button id="clearSig" class="danger">Limpar</button>
    <button id="applySig" class="primary">Colocar no Contrato</button>
    <hr style="border:0; border-top:1px solid var(--line); margin:15px 0;">
    <button id="exportPdf" class="success" disabled>Baixar PDF Assinado</button>
    <div class="status" id="status">Aguardando PDF...</div>
  </section>

  <section class="card">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
       <span>Pág: <b id="pageNum">1</b> / <b id="pageCount">?</b></span>
       <div style="display:flex; gap:5px;">
         <button onclick="changePage(-1)" style="padding:5px 10px; width:auto">◀</button>
         <button onclick="changePage(1)" style="padding:5px 10px; width:auto">▶</button>
       </div>
    </div>

    <div class="stage" id="stage">
      <canvas id="pdfCanvas"></canvas>
      <img id="sigStamp" alt="Assinatura" />
    </div>
  </section>
</main>

<script>
  const PDF_PATH = "Mynd.pdf"; // Verifique se o arquivo está com M maiúsculo!
  
  let pdfDoc = null, pageNum = 1, hasInk = false;
  const sigCanvas = document.getElementById("sigCanvas");
  const sctx = sigCanvas.getContext("2d");
  const statusEl = document.getElementById("status");
  const sigStamp = document.getElementById("sigStamp");

  // --- LÓGICA DA ASSINATURA (TINTA PRETA) ---
  function setupSig() {
    const rect = sigCanvas.getBoundingClientRect();
    sigCanvas.width = rect.width;
    sigCanvas.height = rect.height;
    sctx.strokeStyle = "#000000"; // TINTA PRETA
    sctx.lineWidth = 3;
    sctx.lineCap = "round";
  }

  let drawing = false;
  const start = (e) => { drawing = true; sctx.beginPath(); move(e); };
  const end = () => { drawing = false; };
  const move = (e) => {
    if(!drawing) return;
    const rect = sigCanvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    sctx.lineTo(x, y);
    sctx.stroke();
    hasInk = true;
    e.preventDefault();
  };

  sigCanvas.addEventListener("mousedown", start);
  sigCanvas.addEventListener("mousemove", move);
  window.addEventListener("mouseup", end);
  sigCanvas.addEventListener("touchstart", start, {passive:false});
  sigCanvas.addEventListener("touchmove", move, {passive:false});
  sigCanvas.addEventListener("touchend", end);

  document.getElementById("clearSig").onclick = () => {
    sctx.clearRect(0,0,sigCanvas.width, sigCanvas.height);
    hasInk = false;
    sigStamp.style.display = "none";
  };

  // --- LÓGICA DO PDF (CORREÇÃO DE RENDERIZAÇÃO) ---
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  async function loadPdf() {
    try {
      pdfDoc = await pdfjsLib.getDocument(PDF_PATH).promise;
      document.getElementById("pageCount").textContent = pdfDoc.numPages;
      renderPage();
      statusEl.textContent = "Contrato carregado!";
    } catch(e) {
      statusEl.textContent = "Erro: Arquivo Mynd.pdf não encontrado.";
      console.error(e);
    }
  }

  async function renderPage() {
    const page = await pdfDoc.getPage(pageNum);
    const stageWidth = document.getElementById("stage").clientWidth;
    const viewportOriginal = page.getViewport({ scale: 1 });
    const scale = stageWidth / viewportOriginal.width; // Faz o PDF caber na largura da tela
    const viewport = page.getViewport({ scale: scale * 2 }); // Renderiza em 2x para nitidez

    const canvas = document.getElementById("pdfCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
    document.getElementById("pageNum").textContent = pageNum;
  }

  window.changePage = (dir) => {
    if(!pdfDoc) return;
    pageNum = Math.min(Math.max(1, pageNum + dir), pdfDoc.numPages);
    renderPage();
  };

  // --- LÓGICA DE ARRASTAR (TOUCH E MOUSE) ---
  document.getElementById("applySig").onclick = () => {
    if(!hasInk) return alert("Assine primeiro!");
    sigStamp.src = sigCanvas.toDataURL("image/png");
    sigStamp.style.display = "block";
    document.getElementById("exportPdf").disabled = false;
    statusEl.textContent = "Arraste a assinatura para o local correto.";
  };

  let isDragging = false, startX, startY;
  const dragStart = (e) => {
    isDragging = true;
    const t = e.touches ? e.touches[0] : e;
    startX = t.clientX - sigStamp.offsetLeft;
    startY = t.clientY - sigStamp.offsetTop;
  };
  const dragMove = (e) => {
    if(!isDragging) return;
    const t = e.touches ? e.touches[0] : e;
    sigStamp.style.left = (t.clientX - startX) + "px";
    sigStamp.style.top = (t.clientY - startY) + "px";
    e.preventDefault();
  };
  sigStamp.addEventListener("mousedown", dragStart);
  window.addEventListener("mousemove", dragMove);
  window.addEventListener("mouseup", () => isDragging = false);
  sigStamp.addEventListener("touchstart", dragStart);
  window.addEventListener("touchmove", dragMove, {passive:false});
  window.addEventListener("touchend", () => isDragging = false);

  // --- EXPORTAR PDF FINAL ---
  document.getElementById("exportPdf").onclick = async () => {
    statusEl.textContent = "Gerando arquivo...";
    const pdfBytes = await fetch(PDF_PATH).then(res => res.arrayBuffer());
    const pdfLibDoc = await PDFLib.PDFDocument.load(pdfBytes);
    const page = pdfLibDoc.getPage(pageNum - 1);
    
    const sigImg = await pdfLibDoc.embedPng(sigCanvas.toDataURL("image/png"));
    
    // Cálculos de proporção para o PDF real
    const canvas = document.getElementById("pdfCanvas");
    const { width, height } = page.getSize();
    
    const x = (sigStamp.offsetLeft / canvas.clientWidth) * width;
    const y = height - ((sigStamp.offsetTop / canvas.clientHeight) * height) - ((sigStamp.clientHeight / canvas.clientHeight) * height);
    const w = (sigStamp.clientWidth / canvas.clientWidth) * width;
    const h = (sigStamp.clientHeight / canvas.clientHeight) * height;

    page.drawImage(sigImg, { x, y, width: w, height: h });
    
    const savedBytes = await pdfLibDoc.save();
    const blob = new Blob([savedBytes], {type: "application/pdf"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Contrato_Assinado.pdf";
    link.click();
    statusEl.textContent = "Pronto! PDF baixado.";
  };

  window.onload = () => { setupSig(); loadPdf(); };
  window.onresize = setupSig;
</script>
</body>
</html>

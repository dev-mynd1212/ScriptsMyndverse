<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes" />
  <title>Assinatura Digital ‚Ä¢ MyndVerse</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#0f1625;
      --card2:#0c1220;
      --txt:#ffffff;
      --muted:#a9b6d3;
      --accent:#6ea8ff;
      --ok:#2ee59d;
      --danger:#ff5d5d;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --line: rgba(255,255,255,.08);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--font);
      background: var(--bg);
      color:var(--txt);
      min-height:100vh;
    }

    header{
      padding:18px 14px 8px;
      max-width:1200px;
      margin:0 auto;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(110,168,255,.95), rgba(46,229,157,.75));
    }
    .title{ display:flex;flex-direction:column; line-height:1.05; }
    .title b{ font-size:14px; letter-spacing:.2px;}
    .title span{ font-size:12px; color:var(--muted); margin-top:4px;}
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-size:12px;
    }

    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:8px 14px 28px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    .card{
      background: var(--card);
      border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      padding:14px 14px 8px;
      font-size:14px;
    }
    .sub{
      padding:0 14px 12px;
      color:var(--muted);
      font-size:12px;
    }
    .section{
      padding:12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.06);
      background: var(--card2);
    }

    .btnrow{ display:flex; flex-wrap:wrap; gap:10px; }
    button{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:12px 16px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.45; cursor:not-allowed; }

    .primary{
      background: linear-gradient(135deg, rgba(110,168,255,.95), rgba(110,168,255,.55));
      color:#081225;
    }
    .success{
      background: linear-gradient(135deg, rgba(46,229,157,.95), rgba(46,229,157,.55));
      color:#061a14;
    }

    .sigbox{
      background: rgba(0,0,0,.25);
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;
      padding:12px;
    }
    .sigcanvas{
      width:100%;
      height:170px;
      display:block;
      background: white;
      border-radius:12px;
      touch-action:none;
    }

    .field input{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      margin-bottom:10px;
    }

    /* Viewer simples */
    .viewer{
      padding:14px;
    }

    #pages{
      display:flex;
      flex-direction:column;
      gap:20px;
      margin:15px 0;
    }
    .pageWrap{
      position:relative;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.25);
    }
    .pageWrap.selected{
      outline: 3px solid #6ea8ff;
    }
    .pageCanvas{
      display:block;
      width:100%;
      height:auto;
    }
    .overlay{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .stamp{
      position:absolute;
      width:220px;
      opacity:0.98;
      cursor:move;
      pointer-events:auto;
      touch-action:none;
      border-radius:8px;
    }
    .stamp.selected{
      outline: 3px solid #2ee59d;
    }
    .pageBadge{
      position:absolute;
      left:10px; top:10px;
      padding:6px 9px;
      border-radius:999px;
      background: rgba(0,0,0,.5);
      font-size:12px;
    }

    .status{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }

    .simple-controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin:10px 0;
      padding:10px;
      background: rgba(255,255,255,.03);
      border-radius:12px;
    }
    .simple-controls label{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
    }
    .simple-controls input[type="range"]{
      width:100px;
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div class="title">
      <b>Assinatura Digital ‚Ä¢ MyndVerse</b>
      <span>Assine e coloque na p√°gina 2</span>
    </div>
  </div>
  <div class="pill">Arquivo: Mynd.pdf</div>
</header>

<main class="wrap">
  <!-- Signature area -->
  <section class="card">
    <h2>‚úçÔ∏è Assine aqui</h2>
    <div class="sub">
      Desenhe sua assinatura, depois clique em "Colocar na p√°gina 2"
    </div>

    <div class="section">
      <div class="sigbox">
        <canvas id="sigCanvas" class="sigcanvas"></canvas>
      </div>

      <input id="inpName" placeholder="Seu nome (opcional)" />
      <input id="inpCpf" placeholder="CPF (opcional)" />

      <div class="simple-controls">
        <label>
          Tamanho
          <input id="sizeRange" type="range" min="120" max="400" value="220" />
        </label>
        <label>
          Opacidade
          <input id="opRange" type="range" min="50" max="100" value="98" />
        </label>
      </div>

      <div class="btnrow">
        <button id="clearSig">Limpar</button>
        <button id="addSigPage2" class="primary">üìÑ Colocar na p√°gina 2</button>
        <button id="deleteStamp">üóëÔ∏è Remover</button>
      </div>

      <div class="btnrow">
        <button id="exportPdf" class="success" disabled>üì• Baixar PDF assinado</button>
      </div>

      <div class="status" id="status"></div>
    </div>
  </section>

  <!-- PDF preview simples -->
  <section class="card viewer">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px">
      <span>Visualiza√ß√£o do PDF</span>
      <span id="pageCount">Carregando...</span>
    </div>

    <div id="pages"></div>
    
    <div style="text-align:center; margin-top:10px; color:var(--muted); font-size:12px">
      üëÜ Use o zoom do navegador (gesto de pin√ßa) para ampliar
    </div>
  </section>
</main>

<!-- PDF.js e pdf-lib -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

<script>
  (function() {
    // Configura√ß√£o simples
    const PDF_PATH = "./Mynd.pdf";
    
    // Elementos
    const statusEl = document.getElementById("status");
    const sigCanvas = document.getElementById("sigCanvas");
    const pagesEl = document.getElementById("pages");
    const pageCountEl = document.getElementById("pageCount");
    const clearSigBtn = document.getElementById("clearSig");
    const addSigPage2Btn = document.getElementById("addSigPage2");
    const exportPdfBtn = document.getElementById("exportPdf");
    const deleteStampBtn = document.getElementById("deleteStamp");
    const sizeRange = document.getElementById("sizeRange");
    const opRange = document.getElementById("opRange");
    const inpName = document.getElementById("inpName");
    const inpCpf = document.getElementById("inpCpf");

    // Canvas de assinatura
    const ctx = sigCanvas.getContext("2d");
    let drawing = false;
    let hasSignature = false;

    function resizeCanvas() {
      const rect = sigCanvas.getBoundingClientRect();
      sigCanvas.width = rect.width;
      sigCanvas.height = rect.height;
      ctx.lineWidth = 2.5;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#000";
    }

    function getCoords(e) {
      const rect = sigCanvas.getBoundingClientRect();
      const touch = e.touches && e.touches[0];
      const clientX = touch ? touch.clientX : e.clientX;
      const clientY = touch ? touch.clientY : e.clientY;
      return {
        x: clientX - rect.left,
        y: clientY - rect.top
      };
    }

    function startDraw(e) {
      e.preventDefault();
      drawing = true;
      const p = getCoords(e);
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
    }

    function draw(e) {
      e.preventDefault();
      if (!drawing) return;
      const p = getCoords(e);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      hasSignature = true;
    }

    function stopDraw() {
      drawing = false;
    }

    sigCanvas.addEventListener("pointerdown", startDraw);
    sigCanvas.addEventListener("pointermove", draw);
    sigCanvas.addEventListener("pointerup", stopDraw);
    sigCanvas.addEventListener("pointerleave", stopDraw);
    sigCanvas.addEventListener("touchstart", startDraw, { passive: false });
    sigCanvas.addEventListener("touchmove", draw, { passive: false });
    sigCanvas.addEventListener("touchend", stopDraw);

    clearSigBtn.addEventListener("click", () => {
      ctx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
      hasSignature = false;
      setStatus("Assinatura limpa");
    });

    // Extrair assinatura como PNG (remove fundo branco)
    function getSignatureAsPNG() {
      if (!hasSignature) return null;
      
      const w = sigCanvas.width;
      const h = sigCanvas.height;
      const imageData = ctx.getImageData(0, 0, w, h);
      const data = imageData.data;
      
      // Encontrar bounds da assinatura
      let minX = w, minY = h, maxX = 0, maxY = 0;
      
      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          const i = (y * w + x) * 4;
          const r = data[i];
          const g = data[i+1];
          const b = data[i+2];
          
          // Se n√£o for branco (pixel escuro)
          if (r < 240 || g < 240 || b < 240) {
            if (x < minX) minX = x;
            if (y < minY) minY = y;
            if (x > maxX) maxX = x;
            if (y > maxY) maxY = y;
          }
        }
      }
      
      if (maxX < minX) return null; // Nada desenhado
      
      // Adicionar margem
      const padding = 10;
      minX = Math.max(0, minX - padding);
      minY = Math.max(0, minY - padding);
      maxX = Math.min(w - 1, maxX + padding);
      maxY = Math.min(h - 1, maxY + padding);
      
      const width = maxX - minX + 1;
      const height = maxY - minY + 1;
      
      // Criar canvas tempor√°rio
      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = width;
      tempCanvas.height = height;
      const tempCtx = tempCanvas.getContext("2d");
      
      // Copiar apenas a assinatura, tornando fundo branco transparente
      const cutData = ctx.getImageData(minX, minY, width, height);
      const cut = cutData.data;
      
      for (let i = 0; i < cut.length; i += 4) {
        const r = cut[i];
        const g = cut[i+1];
        const b = cut[i+2];
        
        // Se for quase branco, transparente
        if (r > 240 && g > 240 && b > 240) {
          cut[i+3] = 0; // alpha 0
        } else {
          // Preto puro para a assinatura
          cut[i] = 0;
          cut[i+1] = 0;
          cut[i+2] = 0;
          cut[i+3] = 255;
        }
      }
      
      tempCtx.putImageData(cutData, 0, 0);
      return tempCanvas.toDataURL("image/png");
    }

    // ===== PDF Viewer =====
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    
    let pdfDoc = null;
    let numPages = 0;
    const pages = []; // { wrap, canvas, overlay }
    let stamps = [];
    let selectedStamp = null;

    async function loadPDF() {
      setStatus("Carregando PDF...");
      try {
        pdfDoc = await pdfjsLib.getDocument(PDF_PATH).promise;
        numPages = pdfDoc.numPages;
        pageCountEl.textContent = `P√°ginas: ${numPages}`;
        
        pagesEl.innerHTML = "";
        
        for (let i = 1; i <= numPages; i++) {
          await renderPage(i);
        }
        
        setStatus("PDF carregado. Coloque a assinatura na p√°gina 2.");
      } catch (err) {
        setStatus("Erro ao carregar PDF. Verifique se o arquivo Mynd.pdf existe.");
        console.error(err);
      }
    }

    async function renderPage(pageNum) {
      const page = await pdfDoc.getPage(pageNum);
      
      // Calcular escala para caber na tela
      const containerWidth = pagesEl.clientWidth || 800;
      const viewport = page.getViewport({ scale: 1.0 });
      const scale = containerWidth / viewport.width;
      const scaledViewport = page.getViewport({ scale });
      
      // Criar elementos
      const wrap = document.createElement("div");
      wrap.className = "pageWrap";
      wrap.dataset.pageIndex = pageNum - 1;
      
      const canvas = document.createElement("canvas");
      canvas.className = "pageCanvas";
      canvas.width = scaledViewport.width;
      canvas.height = scaledViewport.height;
      canvas.style.width = "100%";
      canvas.style.height = "auto";
      
      const overlay = document.createElement("div");
      overlay.className = "overlay";
      
      const badge = document.createElement("div");
      badge.className = "pageBadge";
      badge.textContent = `P√°gina ${pageNum}`;
      
      wrap.appendChild(canvas);
      wrap.appendChild(overlay);
      wrap.appendChild(badge);
      pagesEl.appendChild(wrap);
      
      // Renderizar p√°gina
      await page.render({
        canvasContext: canvas.getContext("2d"),
        viewport: scaledViewport
      }).promise;
      
      pages.push({ wrap, canvas, overlay, pageNum, width: scaledViewport.width, height: scaledViewport.height });
      
      // Selecionar p√°gina 2 automaticamente
      if (pageNum === 2) {
        wrap.classList.add("selected");
      }
    }

    // Adicionar assinatura na p√°gina 2
    addSigPage2Btn.addEventListener("click", () => {
      const sigDataUrl = getSignatureAsPNG();
      if (!sigDataUrl) {
        setStatus("Desenhe uma assinatura primeiro");
        return;
      }
      
      // Encontrar p√°gina 2
      const page2 = pages.find(p => p.pageNum === 2);
      if (!page2) {
        setStatus("P√°gina 2 n√£o encontrada");
        return;
      }
      
      // Criar elemento da assinatura
      const img = document.createElement("img");
      img.className = "stamp";
      img.src = sigDataUrl;
      img.style.left = "50px";
      img.style.top = "150px";
      img.style.width = sizeRange.value + "px";
      img.style.opacity = opRange.value / 100;
      img.dataset.rotation = "0";
      img.dataset.pageIndex = "1"; // p√°gina 2 (0-based)
      
      page2.overlay.appendChild(img);
      
      // Armazenar dados
      const stampObj = {
        el: img,
        pageIndex: 1,
        dataUrl: sigDataUrl,
        x: 50,
        y: 150,
        width: parseInt(sizeRange.value),
        opacity: opRange.value / 100,
        rotation: 0
      };
      stamps.push(stampObj);
      
      // Habilitar intera√ß√µes
      makeStampDraggable(img);
      
      // Selecionar
      selectStamp(img);
      
      updateExportButton();
      setStatus("Assinatura colocada na p√°gina 2. Arraste para posicionar.");
    });

    function makeStampDraggable(img) {
      let dragging = false;
      let startX, startY, startLeft, startTop;
      
      function onDown(e) {
        e.preventDefault();
        dragging = true;
        selectStamp(img);
        
        const rect = img.getBoundingClientRect();
        const touch = e.touches && e.touches[0];
        startX = touch ? touch.clientX : e.clientX;
        startY = touch ? touch.clientY : e.clientY;
        startLeft = rect.left;
        startTop = rect.top;
      }
      
      function onMove(e) {
        if (!dragging) return;
        e.preventDefault();
        
        const touch = e.touches && e.touches[0];
        const clientX = touch ? touch.clientX : e.clientX;
        const clientY = touch ? touch.clientY : e.clientY;
        
        const dx = clientX - startX;
        const dy = clientY - startY;
        
        const newLeft = startLeft + dx;
        const newTop = startTop + dy;
        
        // Limitar ao overlay
        const overlay = img.parentElement;
        const overlayRect = overlay.getBoundingClientRect();
        const imgWidth = img.offsetWidth;
        const imgHeight = img.offsetHeight;
        
        const maxLeft = overlayRect.right - imgWidth;
        const maxTop = overlayRect.bottom - imgHeight;
        
        img.style.left = Math.max(overlayRect.left, Math.min(newLeft, maxLeft)) - overlayRect.left + "px";
        img.style.top = Math.max(overlayRect.top, Math.min(newTop, maxTop)) - overlayRect.top + "px";
        
        // Atualizar objeto
        const obj = stamps.find(s => s.el === img);
        if (obj) {
          obj.x = parseFloat(img.style.left);
          obj.y = parseFloat(img.style.top);
        }
      }
      
      function onUp() {
        dragging = false;
      }
      
      img.addEventListener("pointerdown", onDown);
      img.addEventListener("touchstart", onDown, { passive: false });
      window.addEventListener("pointermove", onMove);
      window.addEventListener("touchmove", onMove, { passive: false });
      window.addEventListener("pointerup", onUp);
      window.addEventListener("touchend", onUp);
      
      img.addEventListener("click", (e) => {
        e.stopPropagation();
        selectStamp(img);
      });
    }

    function selectStamp(img) {
      if (selectedStamp) {
        selectedStamp.classList.remove("selected");
      }
      selectedStamp = img;
      if (img) {
        img.classList.add("selected");
        deleteStampBtn.disabled = false;
        
        // Atualizar sliders
        sizeRange.value = parseInt(img.style.width) || 220;
        opRange.value = Math.round((parseFloat(img.style.opacity) || 0.98) * 100);
      } else {
        deleteStampBtn.disabled = true;
      }
    }

    // Atualizar stamp selecionado com sliders
    sizeRange.addEventListener("input", () => {
      if (selectedStamp) {
        selectedStamp.style.width = sizeRange.value + "px";
        const obj = stamps.find(s => s.el === selectedStamp);
        if (obj) obj.width = parseInt(sizeRange.value);
      }
    });

    opRange.addEventListener("input", () => {
      if (selectedStamp) {
        selectedStamp.style.opacity = opRange.value / 100;
        const obj = stamps.find(s => s.el === selectedStamp);
        if (obj) obj.opacity = opRange.value / 100;
      }
    });

    deleteStampBtn.addEventListener("click", () => {
      if (selectedStamp) {
        const idx = stamps.findIndex(s => s.el === selectedStamp);
        if (idx !== -1) stamps.splice(idx, 1);
        selectedStamp.remove();
        selectStamp(null);
        updateExportButton();
        setStatus("Assinatura removida");
      }
    });

    // Exportar PDF
    async function exportPDF() {
      if (stamps.length === 0) {
        setStatus("Adicione uma assinatura primeiro");
        return;
      }
      
      setStatus("Gerando PDF assinado...");
      
      try {
        const response = await fetch(PDF_PATH);
        const pdfBytes = await response.arrayBuffer();
        const doc = await PDFLib.PDFDocument.load(pdfBytes);
        
        for (const s of stamps) {
          const page = doc.getPage(s.pageIndex);
          const { width: pageWidth, height: pageHeight } = page.getSize();
          
          // Dimens√µes da p√°gina na tela
          const pageEl = pages.find(p => p.pageNum === s.pageIndex + 1);
          if (!pageEl) continue;
          
          const overlayWidth = pageEl.overlay.clientWidth;
          const overlayHeight = pageEl.overlay.clientHeight;
          
          // Converter coordenadas
          const x = (s.x / overlayWidth) * pageWidth;
          const y = pageHeight - ((s.y + s.el.offsetHeight) / overlayHeight) * pageHeight;
          const width = (s.el.offsetWidth / overlayWidth) * pageWidth;
          const height = (s.el.offsetHeight / overlayHeight) * pageHeight;
          
          // Embed da imagem
          const pngBytes = await fetch(s.dataUrl).then(r => r.arrayBuffer());
          const pngImage = await doc.embedPng(pngBytes);
          
          page.drawImage(pngImage, {
            x, y,
            width, height,
            opacity: s.opacity
          });
          
          // Texto de auditoria
          const name = inpName.value.trim();
          const cpf = inpCpf.value.trim();
          
          if (name || cpf) {
            const font = await doc.embedFont(PDFLib.StandardFonts.Helvetica);
            const text = `Assinado por: ${name || "‚Äî"} ${cpf ? "CPF: " + cpf : ""} ‚Ä¢ ${new Date().toLocaleString('pt-BR')}`;
            
            page.drawText(text, {
              x: Math.max(20, x),
              y: y - 15,
              size: 8,
              font,
              color: PDFLib.rgb(0.2, 0.2, 0.2)
            });
          }
        }
        
        const outBytes = await doc.save();
        const blob = new Blob([outBytes], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement("a");
        a.href = url;
        a.download = "Mynd_assinado.pdf";
        a.click();
        
        URL.revokeObjectURL(url);
        setStatus("PDF baixado com sucesso!");
      } catch (err) {
        setStatus("Erro ao gerar PDF");
        console.error(err);
      }
    }

    exportPdfBtn.addEventListener("click", exportPDF);

    function updateExportButton() {
      exportPdfBtn.disabled = stamps.length === 0;
    }

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    // Inicializa√ß√£o
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);
    loadPDF();
  })();
</script>
</body>
</html>

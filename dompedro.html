<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Assinatura Digital • MyndVerse</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#0b0f17;
  color:#fff;
}

.container{
  max-width:900px;
  margin:auto;
  padding:20px;
}

.card{
  background:#111827;
  border-radius:14px;
  padding:20px;
  margin-bottom:25px;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
}

h2{
  margin-top:0;
  font-size:18px;
}

canvas{
  width:100%;
  height:160px;
  background:#fff;
  border-radius:10px;
}

button{
  padding:12px 16px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
  margin-right:8px;
}

.primary{background:#3b82f6;color:#fff;}
.success{background:#10b981;color:#000;}
.danger{background:#ef4444;color:#fff;}

.pageWrap{
  position:relative;
  margin-bottom:25px;
  border-radius:12px;
  overflow:hidden;
  background:#000;
}

.pageWrap canvas{
  width:100%;
  height:auto;
  display:block;
}

.status{
  margin-top:12px;
  font-size:14px;
  opacity:.8;
}
</style>
</head>

<body>
<div class="container">

<div class="card">
<h2>Assine abaixo</h2>
<canvas id="sigCanvas"></canvas>
<br>
<button class="danger" id="clearSig">Limpar</button>
<button class="primary" id="addSig">Adicionar na 2ª página</button>
<button class="success" id="exportPdf" disabled>Baixar PDF</button>
<div class="status" id="status"></div>
</div>

<div id="pages"></div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

<script>
const PDF_PATH = "./Mynd.pdf";
const SIGN_PAGE_INDEX = 1; // segunda página

pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const sigCanvas = document.getElementById("sigCanvas");
const sctx = sigCanvas.getContext("2d");
const pagesEl = document.getElementById("pages");
const exportBtn = document.getElementById("exportPdf");
const addSigBtn = document.getElementById("addSig");
const clearSigBtn = document.getElementById("clearSig");
const statusEl = document.getElementById("status");

let drawing=false;
let hasInk=false;
let pdfDoc=null;
let stampData=null;

function setStatus(msg){ statusEl.innerText=msg; }

// ===== ASSINATURA CONTÍNUA REAL =====
function resizeSignature(){
  const rect=sigCanvas.getBoundingClientRect();
  const dpr=window.devicePixelRatio||1;
  sigCanvas.width=rect.width*dpr;
  sigCanvas.height=rect.height*dpr;
  sctx.setTransform(dpr,0,0,dpr,0,0);
  sctx.lineWidth=2.5;
  sctx.lineCap="round";
  sctx.lineJoin="round";
  sctx.strokeStyle="#000";
}
resizeSignature();
window.addEventListener("resize",resizeSignature);

function getPosition(e){
  const rect=sigCanvas.getBoundingClientRect();
  const touch=e.touches?e.touches[0]:e;
  return{
    x:touch.clientX-rect.left,
    y:touch.clientY-rect.top
  };
}

function startDraw(e){
  drawing=true;
  const p=getPosition(e);
  sctx.beginPath();
  sctx.moveTo(p.x,p.y);
}

function draw(e){
  if(!drawing)return;
  const p=getPosition(e);
  sctx.lineTo(p.x,p.y);
  sctx.stroke();
  hasInk=true;
}

function stopDraw(){
  drawing=false;
  sctx.closePath();
}

sigCanvas.addEventListener("mousedown",startDraw);
sigCanvas.addEventListener("mousemove",draw);
window.addEventListener("mouseup",stopDraw);

sigCanvas.addEventListener("touchstart",startDraw,{passive:false});
sigCanvas.addEventListener("touchmove",function(e){
  draw(e);
  e.preventDefault();
},{passive:false});
window.addEventListener("touchend",stopDraw);

// ===== LIMPAR =====
clearSigBtn.onclick=()=>{
  sctx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  hasInk=false;
  stampData=null;
  setStatus("Assinatura limpa.");
};

// ===== RENDER PDF 100% CORRETO =====
async function loadPdf(){
  pdfDoc=await pdfjsLib.getDocument(PDF_PATH).promise;
  pagesEl.innerHTML="";

  for(let i=1;i<=pdfDoc.numPages;i++){
    const page=await pdfDoc.getPage(i);
    const base=page.getViewport({scale:1});
    const containerWidth=pagesEl.clientWidth;
    const scale=containerWidth/base.width;
    const viewport=page.getViewport({scale});

    const wrap=document.createElement("div");
    wrap.className="pageWrap";

    const canvas=document.createElement("canvas");
    const ctx=canvas.getContext("2d");

    canvas.width=viewport.width;
    canvas.height=viewport.height;

    await page.render({canvasContext:ctx,viewport}).promise;

    wrap.appendChild(canvas);

    if(i-1===SIGN_PAGE_INDEX){
      const overlay=document.createElement("div");
      overlay.id="signOverlay";
      overlay.style.position="absolute";
      overlay.style.inset="0";
      overlay.style.pointerEvents="none";
      wrap.appendChild(overlay);
    }

    pagesEl.appendChild(wrap);
  }

  setStatus("PDF carregado.");
}
loadPdf();

window.addEventListener("resize",loadPdf);

// ===== ADICIONAR ASSINATURA NA SEGUNDA PÁGINA =====
addSigBtn.onclick=()=>{
  if(!hasInk){
    setStatus("Assine antes.");
    return;
  }

  const overlay=document.getElementById("signOverlay");
  overlay.innerHTML="";

  stampData=sigCanvas.toDataURL("image/png");

  const img=document.createElement("img");
  img.src=stampData;
  img.style.position="absolute";
  img.style.left="60px";
  img.style.top="160px";
  img.style.width="220px";
  img.style.cursor="move";

  overlay.style.pointerEvents="auto";
  overlay.appendChild(img);

  enableDrag(img);
  exportBtn.disabled=false;
};

function enableDrag(el){
  let dragging=false,startX=0,startY=0,origX=0,origY=0;

  el.addEventListener("pointerdown",e=>{
    dragging=true;
    startX=e.clientX;
    startY=e.clientY;
    origX=parseFloat(el.style.left);
    origY=parseFloat(el.style.top);
  });

  window.addEventListener("pointermove",e=>{
    if(!dragging)return;
    el.style.left=(origX+(e.clientX-startX))+"px";
    el.style.top=(origY+(e.clientY-startY))+"px";
  });

  window.addEventListener("pointerup",()=>dragging=false);
}

// ===== EXPORTAR =====
exportBtn.onclick=async()=>{
  if(!stampData){
    setStatus("Adicione a assinatura.");
    return;
  }

  setStatus("Gerando PDF...");

  const pdfBytes=await fetch(PDF_PATH).then(r=>r.arrayBuffer());
  const doc=await PDFLib.PDFDocument.load(pdfBytes);

  const page=doc.getPage(SIGN_PAGE_INDEX);
  const {width,height}=page.getSize();

  const overlay=document.getElementById("signOverlay");
  const img=overlay.querySelector("img");

  const overlayW=overlay.clientWidth;
  const overlayH=overlay.clientHeight;

  const leftPx=parseFloat(img.style.left);
  const topPx=parseFloat(img.style.top);
  const stampWpx=img.getBoundingClientRect().width;
  const stampHpx=img.getBoundingClientRect().height;

  const x=(leftPx/overlayW)*width;
  const w=(stampWpx/overlayW)*width;
  const h=(stampHpx/overlayH)*height;
  const y=height-((topPx/overlayH)*height)-h;

  const pngBytes=await fetch(stampData).then(r=>r.arrayBuffer());
  const pngImage=await doc.embedPng(pngBytes);

  page.drawImage(pngImage,{x,y,width:w,height:h});

  const out=await doc.save();
  const blob=new Blob([out],{type:"application/pdf"});
  const url=URL.createObjectURL(blob);

  const a=document.createElement("a");
  a.href=url;
  a.download="Mynd_assinado.pdf";
  a.click();

  setStatus("PDF baixado ✅");
};
</script>
</body>
</html>
